<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Indian Stocks AI Signal Dashboard â€“ Long-Term Upgrade</title>
<style>
body{font-family:Arial;background:#f2f2f2;padding:15px}
h2{text-align:center}
.card{background:#fff;padding:12px;margin-bottom:12px;border-radius:8px}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{border:1px solid #ccc;padding:6px;text-align:center}
th{background:#eee}
.buy{color:green;font-weight:bold}
.sell{color:red;font-weight:bold}
.hold{color:#555}
.badge{padding:4px 8px;border-radius:5px;margin:2px;display:inline-block;color:#fff;font-weight:bold}
.high{background:#22c55e}
.medium{background:#facc15;color:#000}
.low{background:#ef4444}
.trend-up{color:green;font-weight:bold}
.trend-down{color:red;font-weight:bold}
.trend-neutral{color:#555}
</style>
</head>
<body>
<h2>ðŸ‡®ðŸ‡³ Indian Stocks AI Signal Dashboard â€“ Long-Term Upgrade</h2>

<div class="card">
<h4>ðŸ“‹ Watchlist & Signals</h4>
<table>
<thead>
<tr>
<th>Stock</th>
<th>Signal</th>
<th>Confidence</th>
<th>Probability %</th>
<th>RSI</th>
<th>EMA Trend</th>
<th>News Sentiment</th>
<th>Reason</th>
<th>Timestamp</th>
<th>Long-Term Trend</th>
<th>Long-Term Accuracy</th>
<th>BUY Accuracy</th>
<th>SELL Accuracy</th>
</tr>
</thead>
<tbody id="stockTable"></tbody>
</table>
</div>

<script>
// ---- CONFIG ---- //
const watchlist = ["RELIANCE.NS","TCS.NS","INFY.NS","HDFC.NS","ICICIBANK.NS"];
const newsHeadlinesCount = 5;
const refreshInterval = 5*60*1000; // 5 minutes
const longTermEMA = 50; // EMA50 for long-term trend

// ---- STORAGE ---- //
let accuracyTracker = {};
watchlist.forEach(s=>accuracyTracker[s]={buy:{wins:0,total:0},sell:{wins:0,total:0},longTerm:{wins:0,total:0}});

// ---- HELPER FUNCTIONS ---- //
function analyzeSentiment(headlines){
    let score=0;
    const positive=["gain","up","bull","strong","profit","buy","positive","good"];
    const negative=["loss","down","bear","weak","sell","drop","negative","bad"];
    headlines.forEach(h=>{
        let text = h.toLowerCase();
        positive.forEach(p=>{if(text.includes(p))score+=1});
        negative.forEach(n=>{if(text.includes(n))score-=1});
    });
    return Math.max(Math.min(score,5),-5);
}

async function fetchStockData(symbol){
    try{
        let url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=15m&range=1d`;
        let res = await fetch(url);
        let data = await res.json();
        let closes = data.chart.result[0].indicators.quote[0].close;
        let ema = closes.slice(-20).reduce((a,v)=>a+v,0)/20;
        let lastClose = closes[closes.length-1];

        let gains=0, losses=0;
        for(let i=closes.length-14;i<closes.length;i++){
            let diff=closes[i]-closes[i-1];
            if(diff>0) gains+=diff; else losses+=Math.abs(diff);
        }
        let rsi = 100 - (100/(1+(gains/14)/(losses/14)));
        let emaTrend = lastClose>ema?"Up":"Down";
        return {lastClose,ema,emaTrend,rsi};
    }catch(e){console.log(e); return {lastClose:0,emaTrend:"-",rsi:0}};
}

// Fetch long-term historical data (EMA50)
async function fetchLongTermTrend(symbol){
    try{
        let url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=1d&range=6mo`;
        let res = await fetch(url);
        let data = await res.json();
        let closes = data.chart.result[0].indicators.quote[0].close;
        let ema50 = closes.slice(-longTermEMA).reduce((a,v)=>a+v,0)/longTermEMA;
        let lastClose = closes[closes.length-1];
        let trend = lastClose>ema50?"Up":(lastClose<ema50?"Down":"Neutral");
        return {trend,lastClose};
    }catch(e){console.log(e); return {trend:"Neutral",lastClose:0};}
}

// Fetch news
async function fetchNews(symbol){
    try{
        let url=`https://finance.yahoo.com/quote/${symbol}`;
        let res=await fetch(url);
        let html = await res.text();
        let headlines = [...html.matchAll(/"title":"(.*?)"/g)].map(m=>m[1]);
        return headlines.slice(0,newsHeadlinesCount);
    }catch(e){console.log(e); return [];}
}

// AI Signal logic with long-term confirmation
function generateSignal(stockData,longTermData,sentimentScore,symbol){
    let {rsi, emaTrend} = stockData;
    let signal="HOLD",confidence="LOW",prob=50,reason=[];
    
    if(rsi<30 && emaTrend==="Up" && sentimentScore>0 && longTermData.trend==="Up"){
        signal="BUY";
        reason.push("RSI<30 + EMA Up + Positive News + Long-term Uptrend");
        accuracyTracker[symbol].buy.total+=1;
        accuracyTracker[symbol].longTerm.total+=1;
    } else if(rsi>70 && emaTrend==="Down" && sentimentScore<0 && longTermData.trend==="Down"){
        signal="SELL";
        reason.push("RSI>70 + EMA Down + Negative News + Long-term Downtrend");
        accuracyTracker[symbol].sell.total+=1;
        accuracyTracker[symbol].longTerm.total+=1;
    } else if(rsi<50 && emaTrend==="Up" && sentimentScore>=0 && longTermData.trend==="Up"){
        signal="BUY";
        reason.push("RSI<50 + EMA Up + Neutral/Positive News + Long-term Uptrend");
        accuracyTracker[symbol].buy.total+=1;
        accuracyTracker[symbol].longTerm.total+=1;
    } else if(rsi>50 && emaTrend==="Down" && sentimentScore<=0 && longTermData.trend==="Down"){
        signal="SELL";
        reason.push("RSI>50 + EMA Down + Neutral/Negative News + Long-term Downtrend");
        accuracyTracker[symbol].sell.total+=1;
        accuracyTracker[symbol].longTerm.total+=1;
    } else {
        signal="HOLD";
        reason.push("No strong confirmation");
    }
    
    let confScore = Math.abs(sentimentScore)*10 + (signal==="HOLD"?10:30);
    if(confScore>=60) confidence="HIGH";
    else if(confScore>=40) confidence="MEDIUM";
    prob = Math.min(Math.max(confScore,0),100);
    
    return {signal,confidence,prob,reason};
}

// ---- UPDATE DASHBOARD ---- //
async function updateDashboard(){
    let tbody = document.getElementById("stockTable");
    let stockSignals = [];
    for(let stock of watchlist){
        let stockData = await fetchStockData(stock);
        let longTermData = await fetchLongTermTrend(stock);
        let headlines = await fetchNews(stock);
        let sentimentScore = analyzeSentiment(headlines);
        let aiSignal = generateSignal(stockData,longTermData,sentimentScore,stock);
        stockSignals.push({...aiSignal,stock,stockData,longTermData,sentimentScore});
    }
    
    // Sort by probability for ranking
    stockSignals.sort((a,b)=>b.prob - a.prob);
    
    tbody.innerHTML="";
    stockSignals.forEach(s=>{
        let buyAcc = s.stockData.lastClose>0?Math.round((accuracyTracker[s.stock].buy.wins/Math.max(accuracyTracker[s.stock].buy.total,1))*100):0;
        let sellAcc = s.stockData.lastClose>0?Math.round((accuracyTracker[s.stock].sell.wins/Math.max(accuracyTracker[s.stock].sell.total,1))*100):0;
        let longAcc = s.stockData.lastClose>0?Math.round((accuracyTracker[s.stock].longTerm.wins/Math.max(accuracyTracker[s.stock].longTerm.total,1))*100):0;
        
        let trendClass = s.longTermData.trend==="Up"?"trend-up":(s.longTermData.trend==="Down"?"trend-down":"trend-neutral");
        
        let row = `<tr>
            <td>${s.stock}</td>
            <td class="${s.signal.toLowerCase()}">${s.signal}</td>
            <td><span class="badge ${s.confidence.toLowerCase()}">${s.confidence}</span></td>
            <td>${s.prob.toFixed(0)}%</td>
            <td>${s.stockData.rsi.toFixed(1)}</td>
            <td>${s.stockData.emaTrend}</td>
            <td>${s.sentimentScore}</td>
            <td>${s.reason}</td>
            <td>${new Date().toLocaleTimeString()}</td>
            <td class="${trendClass}">${s.longTermData.trend}</td>
            <td>${longAcc}%</td>
            <td>${buyAcc}%</td>
            <td>${sellAcc}%</td>
        </tr>`;
        tbody.innerHTML+=row;
    });
}

// Initial load + auto-refresh
updateDashboard();
setInterval(updateDashboard,refreshInterval);
</script>
</body>
</html>